(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))s(r);new MutationObserver(r=>{for(const n of r)if(n.type==="childList")for(const c of n.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&s(c)}).observe(document,{childList:!0,subtree:!0});function o(r){const n={};return r.integrity&&(n.integrity=r.integrity),r.referrerPolicy&&(n.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?n.credentials="include":r.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function s(r){if(r.ep)return;r.ep=!0;const n=o(r);fetch(r.href,n)}})();const z=()=>document.getElementById("card-template").content.querySelector(".card").cloneNode(!0),F=(e,{onPreviewPicture:t,onLikeIcon:o,onDeleteCard:s},r)=>{const n=z(),c=n.querySelector(".card__like-button"),d=n.querySelector(".card__control-button_type_delete"),_=n.querySelector(".card__image"),b=n.querySelector(".card__like-count");return _.src=e.link,_.alt=e.name,n.querySelector(".card__title").textContent=e.name,b&&e.likes&&(b.textContent=e.likes.length),e.likes&&e.likes.some(S=>S._id===r)&&c.classList.add("card__like-button_is-active"),o&&c.addEventListener("click",S=>{const J=c.classList.contains("card__like-button_is-active");o(c,e._id,J,b)}),e.owner&&e.owner._id===r?(d.style.display="block",s&&d.addEventListener("click",S=>{S.stopPropagation(),s(n,e._id)})):d.style.display="none",t&&_.addEventListener("click",()=>t({name:e.name,link:e.link})),n},N=e=>{if(e.key==="Escape"){const t=document.querySelector(".popup_is-opened");p(t)}},f=e=>{e.classList.add("popup_is-opened"),document.addEventListener("keyup",N)},p=e=>{e.classList.remove("popup_is-opened"),document.removeEventListener("keyup",N)},K=e=>{e.querySelector(".popup__close").addEventListener("click",()=>{p(e)}),e.addEventListener("mousedown",o=>{o.target.classList.contains("popup")&&p(e)})},G=(e,t)=>{const o=e.querySelector(t.submitButtonSelector);o.classList.add(t.inactiveButtonClass),o.disabled=!0},Q=(e,t)=>{const o=e.querySelector(t.submitButtonSelector);o.classList.remove(t.inactiveButtonClass),o.disabled=!1},I=(e,t,o)=>{ee(t)?G(e,o):Q(e,o)},X=(e,t,o,s)=>{const r=e.querySelector(`#${t.id}-error`);t.classList.add(s.inputErrorClass),r.textContent=o,r.classList.add(s.errorClass)},Y=(e,t,o)=>{const s=e.querySelector(`#${t.id}-error`);t.classList.remove(o.inputErrorClass),s.classList.remove(o.errorClass),s.textContent=""},Z=(e,t,o)=>{t.validity.patternMismatch?t.setCustomValidity(t.dataset.errorMessage):t.setCustomValidity(""),t.validity.valid?Y(e,t,o):X(e,t,t.validationMessage,o)},ee=e=>e.some(t=>!t.validity.valid),te=(e,t)=>{const o=Array.from(e.querySelectorAll(t.inputSelector));I(e,o,t),o.forEach(s=>{s.addEventListener("input",()=>{Z(e,s,t),I(e,o,t)})})},oe=e=>{Array.from(document.querySelectorAll(e.formSelector)).forEach(o=>{te(o,e)})},i={baseUrl:"https://mesto.nomoreparties.co/v1/apf-cohort-202",headers:{authorization:"98c7058d-c12d-4ab0-9a8e-d9f57cce8355","Content-Type":"application/json"}},u=e=>e.ok?e.json():Promise.reject(`Ошибка: ${e.status}`),C=()=>fetch(`${i.baseUrl}/users/me`,{headers:i.headers}).then(u),O=()=>fetch(`${i.baseUrl}/cards`,{headers:i.headers}).then(u),ne=({name:e,about:t})=>fetch(`${i.baseUrl}/users/me`,{method:"PATCH",headers:i.headers,body:JSON.stringify({name:e,about:t})}).then(u),re=({avatar:e})=>fetch(`${i.baseUrl}/users/me/avatar`,{method:"PATCH",headers:i.headers,body:JSON.stringify({avatar:e})}).then(u),se=({name:e,link:t})=>fetch(`${i.baseUrl}/cards`,{method:"POST",headers:i.headers,body:JSON.stringify({name:e,link:t})}).then(u),R=e=>fetch(`${i.baseUrl}/cards/${e}`,{method:"DELETE",headers:i.headers}).then(u),ce=(e,t)=>fetch(`${i.baseUrl}/cards/likes/${e}`,{method:t?"DELETE":"PUT",headers:i.headers}).then(o=>u(o)),ie={formSelector:".popup__form",inputSelector:".popup__input",submitButtonSelector:".popup__button",inactiveButtonClass:"popup__button_disabled",inputErrorClass:"popup__input_type_error",errorClass:"popup__error_visible"};oe(ie);const W=document.querySelector(".places__list"),L=document.querySelector(".popup_type_edit"),k=L.querySelector(".popup__form"),H=k.querySelector(".popup__input_type_name"),D=k.querySelector(".popup__input_type_description"),q=document.querySelector(".popup_type_new-card"),y=q.querySelector(".popup__form"),le=y.querySelector(".popup__input_type_card-name"),ae=y.querySelector(".popup__input_type_url"),E=document.querySelector(".popup_type_image"),$=E.querySelector(".popup__image"),ue=E.querySelector(".popup__caption"),pe=document.querySelector(".profile__edit-button"),de=document.querySelector(".profile__add-button"),w=document.querySelector(".profile__title"),x=document.querySelector(".profile__description"),P=document.querySelector(".profile__image"),T=document.querySelector(".popup_type_edit-avatar"),g=T.querySelector(".popup__form"),_e=g.querySelector(".popup__input"),h=document.querySelector(".popup_type_info"),M=document.querySelector(".header__logo"),A=h.querySelector(".popup__title"),a=h.querySelector(".popup__info"),v=h.querySelector(".popup__list"),B=h.querySelector(".popup__text"),U=e=>e.toLocaleDateString("ru-RU",{year:"numeric",month:"long",day:"numeric"}),m=(e,t)=>{const s=document.querySelector("#popup-info-definition-template").content.querySelector(".popup__info-item").cloneNode(!0);return s.querySelector(".popup__info-term").textContent=e,s.querySelector(".popup__info-description").textContent=t,s},me=(e,t=0,o=0)=>{const r=document.querySelector("#popup-info-user-preview-template").content.querySelector(".popup__list-item_type_badge").cloneNode(!0);r.style.backgroundImage=`url(${e.avatar})`;const n=document.createElement("div");return n.innerHTML=`
    <strong>${e.name}</strong><br>
    <small>${e.about||""}</small><br>
    <small>Карточек: ${t} | Лайков: ${o}</small>
  `,r.appendChild(n),r},l=(e,t,o,s)=>{e?(t.textContent=s,t.disabled=!0):(t.textContent=o,t.disabled=!1)},V=({name:e,link:t})=>{$.src=t,$.alt=e,ue.textContent=e,f(E)},fe=e=>{e.preventDefault();const t=e.target.querySelector(".popup__button"),o=t.textContent;l(!0,t,o,"Сохранение..."),ne({name:H.value,about:D.value}).then(s=>{w.textContent=s.name,x.textContent=s.about,p(L)}).catch(s=>{console.log(s)}).finally(()=>{l(!1,t,o,"Сохранение...")})},ye=e=>{e.preventDefault();const t=e.target.querySelector(".popup__button"),o=t.textContent;l(!0,t,o,"Сохранение..."),re({avatar:_e.value}).then(s=>{P.style.backgroundImage=`url(${s.avatar})`,p(T),g.reset()}).catch(s=>{console.log(s)}).finally(()=>{l(!1,t,o,"Сохранение...")})},he=e=>{e.preventDefault();const t=e.target.querySelector(".popup__button"),o=t.textContent;l(!0,t,o,"Создание..."),C().then(s=>{se({name:le.value,link:ae.value}).then(r=>{W.prepend(F({name:r.name,link:r.link,owner:r.owner,_id:r._id,likes:r.likes},{onPreviewPicture:V,onLikeIcon:j,onDeleteCard:n=>{R(r._id).then(()=>{n.remove()}).catch(c=>{console.log(c)})}},s._id)),p(q),y.reset()}).catch(r=>{console.log(r)}).finally(()=>{l(!1,t,o,"Создание...")})}).catch(s=>{console.log(s),l(!1,t,o,"Создание...")})},j=(e,t,o,s)=>{const r=e.textContent||"";l(!0,e,r,""),ce(t,o).then(n=>{e.classList.toggle("card__like-button_is-active"),s&&(s.textContent=n.likes.length)}).catch(n=>{console.log(n)}).finally(()=>{l(!1,e,r,"")})},Se=()=>{O().then(e=>{a&&(a.innerHTML=""),v&&(v.innerHTML=""),C().then(t=>{A&&(A.textContent=`Статистика ваших данных, ${t.name}`),B&&(B.textContent="Пользователи в проекте:");const o=new Map;o.set(t._id,{user:t,cardsCount:0,likesReceived:0}),e.forEach(n=>{if(o.has(n.owner._id)){const c=o.get(n.owner._id);c.cardsCount+=1,c.likesReceived+=n.likes.length}else o.set(n.owner._id,{user:n.owner,cardsCount:1,likesReceived:n.likes.length})});const s=Array.from(o.values()).sort((n,c)=>c.cardsCount-n.cardsCount||c.likesReceived-n.likesReceived);v&&s.forEach(n=>{const c=me(n.user,n.cardsCount,n.likesReceived);n.user._id===t._id&&c.classList.add("popup__list-item_current-user"),v.append(c)});const r=[...e].sort((n,c)=>new Date(n.createdAt)-new Date(c.createdAt));if(a){a.append(m("Всего карточек в проекте:",e.length.toString())),a.append(m("Всего участников:",s.length.toString())),r.length>0&&(a.append(m("Первая карточка создана:",U(new Date(r[0].createdAt)))),a.append(m("Последняя карточка создана:",U(new Date(r[r.length-1].createdAt)))));const n=e.reduce((d,_)=>d+_.likes.length,0),c=e.length>0?(n/e.length).toFixed(1):"0";a.append(m("Среднее число лайков на карточку:",c))}f(h)})}).catch(e=>{console.log(e)})};k.addEventListener("submit",fe);y.addEventListener("submit",he);g.addEventListener("submit",ye);pe.addEventListener("click",()=>{H.value=w.textContent,D.value=x.textContent,f(L)});P.addEventListener("click",()=>{g.reset(),f(T)});de.addEventListener("click",()=>{y.reset(),f(q)});M&&M.addEventListener("click",Se);const ve=document.querySelectorAll(".popup");ve.forEach(e=>{K(e)});Promise.all([O(),C()]).then(([e,t])=>{w.textContent=t.name,x.textContent=t.about,P.style.backgroundImage=`url(${t.avatar})`,e.forEach(o=>{W.append(F({name:o.name,link:o.link,owner:o.owner,_id:o._id,likes:o.likes},{onPreviewPicture:V,onLikeIcon:j,onDeleteCard:s=>{R(o._id).then(()=>{s.remove()}).catch(r=>{console.log(r)})}},t._id))})}).catch(e=>{console.log(e)});
